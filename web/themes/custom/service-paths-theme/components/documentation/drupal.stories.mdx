import { Meta } from '@storybook/addon-docs';
import { Docs } from '../storybook/storybook'

<Meta title="Documentation/Drupal integration" />

<Docs language="en">

# Integration of the components

_Note: This documentation page mainly focuses on developers._

The components are written in [Twig](https://twig.symfony.com). They are originally written to be used in Drupal, but
they can be run in any framework that supports Twig.
A Storybook component contains following items:

- a template for the markup
- a scss file for the styling
- one or several yaml files for the placeholder data
- a react file that builds the component in the Storybook

The component template contains the markup of the component and the variables where the data will be passed. The markup
can also include other components. For example, in the _CTA component_, there is a heading that is based on the _Heading
component_ and a lead text, based on the _Long text_ component:

```twig
<div {{ bem(cta__base_class, cta__modifiers, cta__blockname) }} >
  {% include "@atoms/text/heading/heading.twig" with {
    heading__level: 3,
    heading__base_class: "title",
    heading__blockname: cta__base_class,
    heading: cta__title,
  } %}

  {% include "@atoms/text/text-long/text-long.twig" with {
    text_long__blockname: cta__base_class,
    text_long__base_class: "text",
    text_long__content:  cta__lead_text,
  } %}

  <div {{ bem("icon-wrapper", [], cta__base_class) }}>
    {% include "@atoms/images/fontawesome-icon/fontawesome-icon.twig" with {
      fontawesome_icon__name: cta__icon,
      fontawesome_icon__blockname: cta__base_class,
    } %}
  </div>

  {% include "@atoms/links/link/link.twig" with {
    link__base_class: "link",
    link__url: cta__link,
    link__icon_before: "arrow-right",
  } %}
</div>
```

The data comes from the yaml file included in the story. The yaml file contains placeholder content that is displayed in
the Storybook. The yaml file of the CTA component gives the values for the variables in the template file, for example:

```twig
cta__title: 'CTA Title'
cta__lead_text: 'CTA lead text'
```

The integration of a component to another framework means replacing the variable values by the data coming from the
framework. For example, in Drupal or other twig based system, we can create a CTA template like this:

```twig
{% include "@molecules/cta/cta.twig" with {
  cta__title: content.field_cta_title,
  cta__lead_text: content.field_cta_text,
} %}
```

In this template we include the CTA component’s template into the Drupal template, and we replace the variables of the
Storybook template by the data coming from Drupal. Modifying the markup in the framework templates should be avoided.


## Integrating components into Drupal

### Differences with regular Drupal Twig templates

The components are written in Twig and behave like regular Drupal Twig templates do with a
few minor differences:

  - Since the components are located inside the `./components` directory instead of `./templates`
  Drupal is not aware of them and ignores them.
  - The components are usually written to be framework independent and do not contain Drupal
  specific markup or CSS. Instead they are built from the perspective of a site builder. The
  main motivation being "what building block do I need as a site builder" instead of
  "how can the markup Drupal gives be made to work as a site building block".

Taking the above mentioned differences into account the integration usually takes two steps:

  1. [Connecting a Drupal template with the component](#connecting-a-drupal-template-with-the-component)
  2. [Mapping Twig variables](#mapping-twig-variables)

### Connecting a Drupal template with the component

![The connection between Drupal and Storybook](/documentation/drupal.jpg)

Twig templates inside the `./templates` directory connect a component to Drupal. The process can be compared to
importing and reusing a template from another theme. Twig namespaces of either `@atoms`, `@molecules`, `@organisms` or
`@template` can be used to reference the component.

```twig
{% include "@molecules/cta/cta.twig" with {
  "cta__title": content.field_cta_title,
  "cta__lead_text": content.field_cta_text,
} %}
```

Even though there is nothing Storybook specific about the connection process it can be tricky at times and will require
some practice. Below will be some hints to help you get started.

**NB:** no markup should be added to Twig files inside `./templates`. All the markup should come from the components.
In many cases this will require dropping extra wrappers added by Drupal.

#### Twig `include` vs `embed` vs `extends`

Integrating components into Drupal does require a firm understanding of Twig's syntax and especially the key differences
between `include` vs `embed` vs `extends` statements. Some hints:

  - `include` can be used as a safe starting point. It should suffice in most cases.
  - `embed` needs to be used when [Twig blocks](https://twig.symfony.com/doc/3.x/functions/block.html) need to be overridden.
  - `extends` is the preferred option when a template should behave exactly like another with the only exception being
  different variable values. E.g., a template for the news content type teaser view mode that reuses the general teaser
  view mode template but needs to override some Twig variable.

### Mapping Twig variables

Usually some mapping of Drupal supplied values is required to get the shape required by the component. Here are some
practical examples.

**Using regular and responsive images**

The recommended approach is to pass the full image field render array to the component and let it print it. I.e., make
sure that you don't pass just the field value or the file path. This way Drupal will take care of using the appropriate
field template once the field gets printed. By default responsive images should work out of the box. You can also
wire a up a customised responsive image component with the respective field template.

**Getting the URL of a link field**

The [Twig Field Value](https://www.drupal.org/project/twig_field_value) Drupal module is used to get the value of
the field.
```twig
{% set card__url = content.field_link|field_value|first["#url"] %}
```

**Checking if a field has a value**

Oftentimes it's not enough to just check if a field's value has a truthy value.
```twig
{% set has_sidebar = content.field_paragraphs_sidebar|render|trim is not empty %}
```

</Docs>

<Docs language="fi">

# Drupal-integraatio

![Yhteys Drupalin ja Storybookin välillä](/documentation/drupal.jpg)

</Docs>
